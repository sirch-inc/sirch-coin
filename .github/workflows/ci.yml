# Comprehensive CI workflow with proper job dependencies
# Shows security -> tests -> build/deploy pipeline in GitHub Actions UI
#
# Artifact Retention: CI builds (7d), Test results (14d), Preview logs (14d)
# See: CICD_ARTIFACT_RETENTION_POLICY.md for complete retention strategy

name: CI Pipeline

on:
  workflow_dispatch:

  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  SOURCE_BRANCH: ${{ github.head_ref || github.ref_name }}
  NODE_OPTIONS: "--max-old-space-size=4096"

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write
  actions: read
  deployments: write

jobs:
  # Security scanning job - runs first
  security:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]') }}
    
    outputs:
      security-status: ${{ steps.security-summary.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN_FOR_GITHUB_ACTIONS }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js and Dependencies
        uses: ./.github/actions/setup
        with:
          cache-key-suffix: security

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD, Unlicense
          comment-summary-in-pr: always
          fail-on-scopes: runtime, development

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,secret,config'
          timeout: '10m'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run NPM security audit
        id: security
        run: |
          echo "Running npm security audit..."
          npm audit --audit-level=moderate --json > audit-results.json || true
          echo "Audit completed"
        continue-on-error: true

      - name: Security summary
        id: security-summary
        run: |
          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "âœ… Security checks completed"

      - name: Upload security results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-results-${{ github.sha }}
          path: |
            trivy-results.sarif
            audit-results.json
          retention-days: 14
          if-no-files-found: warn

  # Linting and type checking job - runs in parallel with security and tests
  lint:
    name: ðŸ“ Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]') }}
    
    outputs:
      lint-status: ${{ steps.lint-summary.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN_FOR_GITHUB_ACTIONS }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js and Dependencies
        uses: ./.github/actions/setup
        with:
          cache-key-suffix: lint

      - name: Run lint checks
        id: lint
        run: npm run lint -- --cache --cache-location .eslintcache --format=@microsoft/eslint-formatter-sarif --output-file eslint-results.sarif
        continue-on-error: true

      - name: Upload ESLint SARIF results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('eslint-results.sarif') != ''
        with:
          sarif_file: 'eslint-results.sarif'
          wait-for-processing: true

      - name: Check TypeScript compilation
        id: typescript
        run: npm run tsc
        continue-on-error: true

      - name: Lint summary
        id: lint-summary
        run: |
          if [[ "${{ steps.lint.outcome }}" == "success" && "${{ steps.typescript.outcome }}" == "success" ]]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "âœ… Linting and type checking passed"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "âŒ Linting or type checking failed"
          fi

      - name: Upload lint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results-${{ github.sha }}
          path: |
            eslint-results.sarif
            .eslintcache
          retention-days: 14
          if-no-files-found: warn

  # Unit testing job - runs in parallel with security and lint
  test:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]') }}
    
    outputs:
      test-status: ${{ steps.test-summary.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN_FOR_GITHUB_ACTIONS }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js and Dependencies
        uses: ./.github/actions/setup
        with:
          cache-key-suffix: test

      - name: Run unit tests with coverage
        id: tests
        run: npm run test:coverage -- --reporter=junit --outputFile=test-results.xml
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always() && hashFiles('coverage/lcov.info') != ''
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        continue-on-error: true

      - name: Test summary
        id: test-summary
        run: |
          if [[ "${{ steps.tests.outcome }}" == "success" ]]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "âœ… All unit tests passed"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "âŒ Some unit tests failed"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: |
            coverage/
            test-results.xml
          retention-days: 14
          if-no-files-found: warn

  # Build and deploy job - runs after security, lint, and tests complete successfully  
  build-deploy:
    name: ðŸš€ Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [security, lint, test]  # Wait for all quality gates
    if: ${{ needs.security.outputs.security-status == 'success' && needs.lint.outputs.lint-status == 'success' && needs.test.outputs.test-status == 'success' }}
    
    environment: 
      name: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && 'production' || 'preview' }}
      url: ${{ steps.create_preview.outputs.NETLIFY_PREVIEW_URL }}
    
    outputs:
      preview-url: ${{ steps.create_preview.outputs.NETLIFY_PREVIEW_URL }}
      build-status: ${{ steps.build-summary.outputs.status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN_FOR_GITHUB_ACTIONS }}
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node.js and Dependencies
        uses: ./.github/actions/setup
        with:
          cache-key-suffix: build
          additional-cache-paths: |
            dist
            node_modules/.vite
            .vite

      - name: Build for TEST environment
        env:
          VITE_SUPABASE_PROJECT_URL: ${{ secrets.VITE_SUPABASE_PROJECT_URL_TEST }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY_TEST }}
          VITE_STRIPE_API_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_API_PUBLISHABLE_KEY_TEST }}
        run: npm run build-test

      - name: Analyze build output
        id: build-analysis
        run: |
          echo "ðŸ—ï¸ Build Analysis"
          if [ -d "dist" ] && [ -n "$(ls -A dist 2>/dev/null)" ]; then
            BUNDLE_SIZE=$(find dist -name "*.js" -exec cat {} + | wc -c | awk '{printf "%.1f", $1/1024}')
            echo "bundle-size-kb=$BUNDLE_SIZE" >> "$GITHUB_OUTPUT"
            echo "âœ… Build completed - Bundle size: ${BUNDLE_SIZE}KB"
          else
            echo "âŒ Build failed - no output generated"
            exit 1
          fi

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        if: github.event_name == 'pull_request'
        with:
          configPath: '.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Create preview deployment
        id: create_preview
        if: github.event_name == 'pull_request'
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)
          PREVIEW_ALIAS="preview-${SHORT_SHA}"
          
          echo "ðŸš€ Deploying preview with alias: $PREVIEW_ALIAS"
          
          npx netlify deploy \
            --no-build \
            --dir=dist \
            --alias="$PREVIEW_ALIAS" \
            --site ${{ secrets.NETLIFY_SITE_ID_TEST }} \
            --auth ${{ secrets.NETLIFY_API_TOKEN_TEST }} \
            --json > deploy_output_branch.json
          
          if [ ! -f "deploy_output_branch.json" ]; then
            echo "âŒ Preview deployment failed"
            exit 1
          fi
          
          NETLIFY_PREVIEW_URL=$(jq -r '.deploy_url' deploy_output_branch.json 2>/dev/null || echo "")
          if [ -z "$NETLIFY_PREVIEW_URL" ] || [ "$NETLIFY_PREVIEW_URL" = "null" ]; then
            echo "âŒ Failed to parse preview URL"
            cat deploy_output_branch.json
            exit 1
          fi
          
          echo "NETLIFY_PREVIEW_URL=$NETLIFY_PREVIEW_URL" >> "$GITHUB_OUTPUT"
          echo "âœ… Preview deployed to: $NETLIFY_PREVIEW_URL"

      - name: Create deployment status
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && steps.create_preview.outputs.NETLIFY_PREVIEW_URL
        env:
          NETLIFY_PREVIEW_URL: ${{ steps.create_preview.outputs.NETLIFY_PREVIEW_URL }}
        with:
          script: |
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Preview Deployment',
              head_sha: context.sha,
              status: 'completed',
              conclusion: 'success',
              details_url: process.env.NETLIFY_PREVIEW_URL,
              output: {
                title: 'ðŸš€ Preview Deployment Ready',
                summary: 'Preview is deployed and ready for testing',
                text: `Preview URL: ${process.env.NETLIFY_PREVIEW_URL}`
              }
            });

      - name: Build summary
        id: build-summary
        run: |
          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "âœ… Build and deploy completed successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-outputs-${{ github.sha }}
          path: |
            dist/
            deploy_output_branch.json
          retention-days: 7
          if-no-files-found: warn

  # Summary job - provides overall pipeline status
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [security, lint, test, build-deploy]
    if: always()
    
    steps:
      - name: Create pipeline summary
        run: |
          echo "# ðŸ”„ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          SECURITY_STATUS="${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}"
          LINT_STATUS="${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}"
          TEST_STATUS="${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}"
          BUILD_STATUS="${{ needs.build-deploy.result == 'success' && 'âœ… Passed' || (needs.build-deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }}"
          
          echo "| Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Security | $SECURITY_STATUS | Dependency review, vulnerability scanning |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Lint & Type Check | $LINT_STATUS | ESLint security rules, TypeScript compilation |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | $TEST_STATUS | Jest tests with coverage reporting |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Build & Deploy | $BUILD_STATUS | Vite build, Lighthouse, preview deployment |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-deploy.outputs.preview-url }}" ]; then
            echo "ðŸ”— **Preview URL**: [${{ needs.build-deploy.outputs.preview-url }}](${{ needs.build-deploy.outputs.preview-url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Overall status
          if [[ "${{ needs.security.result }}" == "success" && "${{ needs.lint.result }}" == "success" && "${{ needs.test.result }}" == "success" && "${{ needs.build-deploy.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **All pipeline stages completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some pipeline stages failed or were skipped.** Check individual job results above." >> $GITHUB_STEP_SUMMARY
          fi