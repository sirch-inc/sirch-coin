# A GitHub Actions workflow for CI (run tests, create preview deploys, etc.)
# This workflow runs on PRs to main and direct pushes to main (for emergency fixes).
#
# Artifact Retention: CI builds (7d), Test results (14d), Preview logs (14d)
# See: CICD_ARTIFACT_RETENTION_POLICY.md for complete retention strategy

# Although Netlify supports continuous deployment from GitHub, we use GitHub Actions here instead in 
# order to run tests before deploying, and to have more control over the build and deploy process.
# See also: https://docs.netlify.com/cli/get-started/#continuous-deployment-with-github-actions.
#
# Additionally, at this time, Netlify (free tier) does not support deploying from private org-based repositories
# like ours, so we are using GitHub Actions for CI which skips this. We can revisit this if we move to a paid
# Netlify plan later, but some research suggests that Netlify builds can be expensive even under paid plans.
#
# We are using the Netlify CLI to deploy here, bypassing Netlify's built-in GitHub integration.

name: CI

on:
  # Run on pushes to main (for direct commits/emergency fixes)
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
  
  # Run on all PRs to main (your primary workflow)
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'

env:
  SOURCE_BRANCH: ${{ github.head_ref || github.ref_name }}  # Fixed: Use source branch for PRs

permissions:
  pull-requests: write
  checks: write


jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Allow skipping CI with commit message
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN_FOR_GITHUB_ACTIONS }}  # Using a privileged PAT here to enable writing to PRs
          fetch-depth: 0  # Fetch full history including tags, which are used in builds for version info
          fetch-tags: true  # Explicitly fetch tags, which are used in builds for version info

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run lint checks
        run: npm run lint

      - name: Run NPM security audit
        run: npm audit --audit-level=moderate

      - name: Run unit tests
        run: npm test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests fail
        with:
          name: test-results-${{ github.sha }}
          path: |
            coverage/
            test-results.xml
            junit.xml
          retention-days: 14

      - name: Build for TEST
        env:
          # grab env "secrets" from GitHub Actions Secrets for safety
          VITE_SUPABASE_PROJECT_URL: ${{ secrets.VITE_SUPABASE_PROJECT_URL_TEST }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY_TEST }}
          VITE_STRIPE_API_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_API_PUBLISHABLE_KEY_TEST }}
          # VITE_BUILD_VERSION: ...obtained by build-variables.sh script that is run during the build
          # VITE_BUILD_VERSION_VERBOSE: ...obtained by build-variables.sh script that is run during the build
        run: npm run build-test

      - name: Create preview deployment
        id: create_preview
        # Only create previews for PRs (not direct pushes to main)
        if: github.event_name == 'pull_request'
        run: |
          # Create safe alias from source branch name
          SAFE_BRANCH=$(echo "${{ env.SOURCE_BRANCH }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          
          # Deploy to Netlify with branch-specific alias
          npx netlify deploy \
            --no-build \
            --dir=dist \
            --alias="preview-${SAFE_BRANCH}-$(echo ${{ github.sha }} | cut -c1-7)" \
            --site ${{ secrets.NETLIFY_SITE_ID_TEST }} \
            --auth ${{ secrets.NETLIFY_API_TOKEN_TEST }} \
            --json > deploy_output_branch.json
          
          # Extract and output the preview URL
          NETLIFY_PREVIEW_URL=$(jq -r '.deploy_url' deploy_output_branch.json)
          echo "NETLIFY_PREVIEW_URL=$NETLIFY_PREVIEW_URL" >> "$GITHUB_OUTPUT"
          echo "Preview deployed to: $NETLIFY_PREVIEW_URL"

      - name: Upload preview deployment logs
        uses: actions/upload-artifact@v4
        if: github.event_name == 'pull_request' && always()
        with:
          name: preview-deployment-logs-${{ github.sha }}
          path: deploy_output_branch.json
          retention-days: 14

      - name: Add URL Preview comment to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && steps.create_preview.outputs.NETLIFY_PREVIEW_URL
        env:
          NETLIFY_PREVIEW_URL: ${{ steps.create_preview.outputs.NETLIFY_PREVIEW_URL }}
        with:
          script: |
            const previewUrl = process.env.NETLIFY_PREVIEW_URL;
            const sourceBranch = '${{ env.SOURCE_BRANCH }}';
            
            const body = `## 🚀 Preview Deployment Ready
            
            **Branch**: \`${sourceBranch}\`
            **Preview URL**: ${previewUrl}
            **Commit**: ${{ github.event.pull_request.head.sha || github.sha }}
            
            All tests passed ✅
            
            **Artifacts**: [Build files & test results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *This preview will be updated automatically when you push new commits to this PR.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Log results for direct pushes to main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "=== Direct push to main detected ==="
          echo "Commit: ${{ github.sha }}"
          echo "Tests: ✅ Passed"
          echo "Build: ✅ Completed"
          echo "No preview created for direct pushes to main"
          echo "=================================="

      - name: Create workflow summary
        if: always()
        run: |
          echo "## 🛠️ CI Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ env.SOURCE_BRANCH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "- **Preview**: ${{ steps.create_preview.outputs.NETLIFY_PREVIEW_URL }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Artifacts**: [View all artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
      
      # After actions
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-build-${{ github.event_name }}-${{ github.sha }}
          path: dist
          retention-days: 7

      - name: Upload build logs and metadata
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-logs-${{ github.sha }}
          path: |
            npm-debug.log*
            yarn-debug.log*
            yarn-error.log*
            .npm/_logs/
          retention-days: 7
          if-no-files-found: ignore